<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Speed Quiz Battle</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Animations */
        @keyframes hit-animation {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        @keyframes flash-animation {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(2) drop-shadow(0 0 10px #ef4444) hue-rotate(-30deg); }
        }
        @keyframes damage-pop {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -20px) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50px) scale(1); opacity: 0; }
        }
        @keyframes popup-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes fall {
            0% { transform: translateY(-20px) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }
        @keyframes gentle-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-hit { animation: hit-animation 0.4s ease-in-out; }
        .animate-flash { animation: flash-animation 0.4s ease-in-out; }
        .damage-popup {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            font-weight: 900;
            color: #ff0000;
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            animation: damage-pop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
        }
        .damage-popup.heal { color: #4ade80; }
        .popup-anim { animation: popup-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .item-use-msg { animation: damage-pop 1s forwards; }
        .float-anim { animation: gentle-float 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white h-[100dvh] overflow-hidden">
    <div id="root" class="h-full w-full"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // --- TYPES & ENUMS ---
    const GameState = {
        Start: 'START',
        CharacterSelection: 'CHARACTER_SELECTION',
        Quiz: 'QUIZ',
        Results: 'RESULTS',
    };

    // --- DATA: CHARACTERS ---
    const characters = [
        { name: 'Pliboci', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/39.png', theme: 'stage' },
        { name: 'Bund', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/133.png', theme: 'field' },
        { name: 'Bumtion', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1.png', theme: 'forest' },
        { name: 'Chanion', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png', theme: 'volcano' },
        { name: 'Squartle', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/7.png', theme: 'ocean' },
        { name: 'Jigof', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/35.png', theme: 'moon' },
        { name: 'Togedi', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/175.png', theme: 'garden' },
        { name: 'Geibori', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/94.png', theme: 'graveyard' },
        { name: 'Lucario', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/448.png', theme: 'mountain' },
    ];

    // --- DATA: MONSTERS ---
    const monsters = [
        { name: 'Gravelusk', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/76.png' },
        { name: 'Crysalia', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/471.png' },
        { name: 'Technomind', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/376.png' },
        { name: 'Togedite', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/378.png' },
        { name: 'Volcandor', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/839.png' },
        { name: 'Venomortis', image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/336.png' },
    ];

    // --- SERVICE: QUIZ DATA ---
    const allQuestions = [
        { question: "ÏπòÌÉÄÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["70 km/h", "110 km/h", "150 km/h"], correctAnswer: "110 km/h", hint: "Í≥†ÏÜçÎèÑÎ°úÏóêÏÑú ÏûêÎèôÏ∞®Í∞Ä Îã¨Î¶¨Îäî ÏÜçÎèÑÏôÄ ÎπÑÏä∑Ìï¥Ïöî." },
        { question: "Îã¨ÌåΩÏù¥Ïùò ÌèâÍ∑† Ïù¥Îèô ÏÜçÎ†•ÏùÄ Î∂ÑÏÜç ÏïΩ Î™á mÏùºÍπåÏöî?", options: ["0.8 m/m", "5 m/m", "10 m/m"], correctAnswer: "0.8 m/m", hint: "1Î∂ÑÏóê 1ÎØ∏ÌÑ∞ÎèÑ Ï±Ñ Í∞ÄÏßÄ Î™ªÌï¥Ïöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ ÏÉàÎ°ú ÏïåÎ†§ÏßÑ Îß§Ïùò ÏµúÍ≥† ÌïòÍ∞ï ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["190 km/h", "390 km/h", "500 km/h"], correctAnswer: "390 km/h", hint: "KTXÎ≥¥Îã§ÎèÑ Ìõ®Ïî¨ Îπ®ÎùºÏöî." },
        { question: "KTX-ÏÇ∞Ï≤ú Í≥†ÏÜçÏó¥Ï∞®Ïùò ÏµúÍ≥† Ïö¥Ìñâ ÏÜçÎèÑÎäî ÏãúÏÜç Î™á kmÏùºÍπåÏöî?", options: ["300 km/h", "200 km/h", "400 km/h"], correctAnswer: "300 km/h", hint: "Ïö∞Î¶¨ÎÇòÎùº Í≥†ÏÜçÏó¥Ï∞®Ïùò Ïù¥Î¶ÑÏóêÎäî '300'Ïù¥ÎùºÎäî Ïà´ÏûêÍ∞Ä ÏûêÏ£º Ïó∞ÏÉÅÎèºÏöî." },
        { question: "ÏÇ¨ÎûåÏù¥ Ïû¨Ï±ÑÍ∏∞Ìï† Îïå Í≥µÍ∏∞Ïùò ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏóê Ïù¥Î•ºÍπåÏöî?", options: ["160 km/h", "60 km/h", "100 km/h"], correctAnswer: "160 km/h", hint: "ÏïºÍµ¨ ÏÑ†ÏàòÍ∞Ä ÎçòÏßÄÎäî Í∞ïÏÜçÍµ¨ÎßåÌÅº Îπ®ÎùºÏöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ Î¨ºÍ≥†Í∏∞Ïù∏ ÎèõÏÉàÏπòÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["50 km/h", "80 km/h", "110 km/h"], correctAnswer: "110 km/h", hint: "ÏπòÌÉÄÍ∞Ä Îã¨Î¶¨Îäî ÏÜçÎèÑÏôÄ ÎòëÍ∞ôÏïÑÏöî." },
        { question: "ÌîÑÎ°úÏïºÍµ¨ Ìà¨ÏàòÍ∞Ä ÎçòÏßÄÎäî Îπ†Î•∏ Í≥µÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ Î≥¥ÌÜµ ÏãúÏÜç Î™á kmÏùºÍπåÏöî?", options: ["160 km/h", "100 km/h", "130 km/h"], correctAnswer: "160 km/h", hint: "Í≥†ÏÜçÎèÑÎ°ú Ï†úÌïú ÏÜçÎèÑÎ≥¥Îã§ Ìõ®Ïî¨ Îπ®ÎùºÏöî." },
        { question: "ÏÜåÎ¶¨Ïùò ÏÜçÎèÑÎäî Í≥µÍ∏∞ Ï§ëÏóêÏÑú Ï¥àÏÜç ÏïΩ Î™á mÏùºÍπåÏöî?", options: ["340 m/s", "540 m/s", "100 m/s"], correctAnswer: "340 m/s", hint: "1Ï¥àÏóê Ïö¥ÎèôÏû• Ìä∏Îûô(400m)ÏùÑ Í±∞Ïùò Îã§ ÎèåÏïÑÏöî." },
        { question: "ÎπõÏùò ÏÜçÎèÑÎäî ÏßÑÍ≥µÏóêÏÑú Ï¥àÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["3Îßå km/s", "15Îßå km/s", "30Îßå km/s"], correctAnswer: "30Îßå km/s", hint: "1Ï¥àÏóê ÏßÄÍµ¨Î•º 7Î∞îÌÄ¥ Î∞òÏù¥ÎÇò Îèå Ïàò ÏûàÏñ¥Ïöî." },
        { question: "ÏΩîÎÅºÎ¶¨Í∞Ä Îã¨Î¶¥ ÎïåÏùò ÏµúÍ≥† ÏÜçÎèÑÎäî ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["10 km/h", "40 km/h", "70 km/h"], correctAnswer: "40 km/h", hint: "Ïö∞ÏÇ¨Ïù∏ Î≥ºÌä∏ÏôÄ ÎπÑÏä∑Ìïú ÏÜçÎèÑÏòàÏöî." },
        { question: "ÏùºÎ∞òÏ†ÅÏù∏ ÏóòÎ¶¨Î≤†Ïù¥ÌÑ∞Ïùò ÌèâÍ∑† ÏÜçÎèÑÎäî Ï¥àÏÜç ÏïΩ Î™á mÏùºÍπåÏöî?", options: ["1.5 m/s", "5 m/s", "10 m/s"], correctAnswer: "1.5 m/s", hint: "ÏÇ¨ÎûåÏù¥ Îπ†Î•¥Í≤å Í±∑Îäî ÏÜçÎèÑÎ≥¥Îã§ Ï°∞Í∏à ÎäêÎ†§Ïöî." },
        { question: "Ïö∞ÏÇ¨Ïù∏ Î≥ºÌä∏Ïùò 100ÎØ∏ÌÑ∞ Îã¨Î¶¨Í∏∞ ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏù∏Í∞ÄÏöî?", options: ["24 km/h", "34 km/h", "44 km/h"], correctAnswer: "44 km/h", hint: "ÏûêÎèôÏ∞®Î°ú ÌïôÍµê Ïïû Ïñ¥Î¶∞Ïù¥ Î≥¥Ìò∏Íµ¨Ïó≠(30km/h)ÏùÑ ÏßÄÎÇ† ÎïåÎ≥¥Îã§ Îπ®ÎùºÏöî." },
        { question: "F1 Í≤ΩÏ£ºÏö© ÏûêÎèôÏ∞®Ïùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ ÏñºÎßàÏùºÍπåÏöî?", options: ["370 km/h", "270 km/h", "470 km/h"], correctAnswer: "370 km/h", hint: "KTXÎ≥¥Îã§ Îçî Îπ®ÎùºÏöî." },
        { question: "ÎÇòÎ¨¥ÎäòÎ≥¥Ïùò ÌèâÍ∑† Ïù¥Îèô ÏÜçÎ†•ÏùÄ Î∂ÑÏÜç ÏïΩ Î™á mÏùºÍπåÏöî?", options: ["2 m/m", "10 m/m", "20 m/m"], correctAnswer: "2 m/m", hint: "Îã¨ÌåΩÏù¥Î≥¥Îã§Îäî Ï°∞Í∏à Îπ†Î•¥ÏßÄÎßå, ÏïÑÏ£º ÎäêÎ†§Ïöî." },
        { question: "Î≥¥Ïûâ 747 Ïó¨Í∞ùÍ∏∞Ïùò ÏàúÌï≠ ÏÜçÎèÑÎäî ÏãúÏÜç ÏïΩ ÏñºÎßàÏùºÍπåÏöî?", options: ["500 km/h", "700 km/h", "900 km/h"], correctAnswer: "900 km/h", hint: "ÏùåÏÜç(ÏïΩ 1200km/h)Ïóê Í±∞Ïùò Í∑ºÏ†ëÌï¥Ïöî." },
        { question: "ÌÉÄÏ°∞Ïùò ÏµúÍ≥† Îã¨Î¶¨Í∏∞ ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["30 km/h", "50 km/h", "70 km/h"], correctAnswer: "70 km/h", hint: "ÏûêÎèôÏ∞® Ï†ÑÏö©ÎèÑÎ°úÎ•º Îã¨Î¶¥ Ïàò ÏûàÏùÑ ÎßåÌÅº Îπ®ÎùºÏöî." },
        { question: "ÌÉúÌíçÏùò Î∞îÎûå ÏÜçÎ†• Í∏∞Ï§ÄÏùÄ Ï¥àÏÜç ÏïΩ Î™á m Ïù¥ÏÉÅÏùºÍπåÏöî?", options: ["17 m/s", "7 m/s", "27 m/s"], correctAnswer: "17 m/s", hint: "17Ïù¥ÎùºÎäî Ïà´ÏûêÎ•º Í∏∞ÏñµÌïòÏÑ∏Ïöî." },
        { question: "Í±∞Î∂ÅÏù¥Ïùò ÌèâÍ∑† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["0.3 km/h", "3 km/h", "1.3 km/h"], correctAnswer: "0.3 km/h", hint: "ÏÇ¨ÎûåÏù¥ Í±∑Îäî Í≤ÉÎ≥¥Îã§ 10Î∞∞ Ïù¥ÏÉÅ ÎäêÎ†§Ïöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ Í≥§Ï∂©Ïù∏ Ïû†ÏûêÎ¶¨Ïùò ÎπÑÌñâ ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["28 km/h", "58 km/h", "88 km/h"], correctAnswer: "58 km/h", hint: "ÏãúÎÇ¥ Ï£ºÌñâ ÏûêÎèôÏ∞® ÏÜçÎèÑÎßåÌÅº Îπ®ÎùºÏöî." },
        { question: "Ï∫•Í±∞Î£®Í∞Ä Îõ∏ ÎïåÏùò ÏàúÍ∞Ñ ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["30 km/h", "50 km/h", "70 km/h"], correctAnswer: "70 km/h", hint: "ÌÉÄÏ°∞ÏôÄ ÎπÑÏä∑Ìïú ÏÜçÎèÑÎ•º ÎÇº Ïàò ÏûàÏñ¥Ïöî." },
        { question: "Í≤ΩÎ≥¥ ÏÑ†ÏàòÏùò ÌèâÍ∑† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ ÏñºÎßàÏùºÍπåÏöî?", options: ["4 km/h", "14 km/h", "24 km/h"], correctAnswer: "14 km/h", hint: "ÏûêÏ†ÑÍ±∞Î•º ÌÉÄÍ≥† Ï≤úÏ≤úÌûà Í∞ÄÎäî ÏÜçÎèÑÏôÄ ÎπÑÏä∑Ìï¥Ïöî." },
        { question: "ÎßêÏù¥ Îã¨Î¶¥ Ïàò ÏûàÎäî ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["48 km/h", "68 km/h", "88 km/h"], correctAnswer: "88 km/h", hint: "Í≥†ÏÜçÎèÑÎ°ú ÏµúÏ†Ä ÏÜçÎèÑ Ï†úÌïú(50km/h)Î≥¥Îã§ Ìõ®Ïî¨ Îπ®ÎùºÏöî." },
        { question: "ÌòàÏï°Ïù¥ ÎåÄÎèôÎß•ÏóêÏÑú ÌùêÎ•¥Îäî ÌèâÍ∑† ÏÜçÎèÑÎäî Ï¥àÏÜç ÏïΩ Î™á cmÏùºÍπåÏöî?", options: ["5 cm/s", "30 cm/s", "60 cm/s"], correctAnswer: "30 cm/s", hint: "30cm Ïûê ÌïòÎÇòÎßåÌÅºÏùÑ 1Ï¥àÏóê ÏßÄÎÇòÍ∞ÄÏöî." },
        { question: "ÏùºÎ∞òÏ†ÅÏù∏ ÎπÑÏùò ÎÇôÌïò ÏÜçÎèÑÎäî Ï¥àÏÜç ÏïΩ Î™á mÏùºÍπåÏöî?", options: ["10 m/s", "30 m/s", "50 m/s"], correctAnswer: "10 m/s", hint: "ÏïÑÌååÌä∏ 3~4Ï∏µ ÎÜíÏù¥Î•º 1Ï¥à ÎßåÏóê Îñ®Ïñ¥Ï†∏Ïöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ Í∞úÏù∏ Í∑∏Î†àÏù¥ÌïòÏö¥ÎìúÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["42 km/h", "72 km/h", "92 km/h"], correctAnswer: "72 km/h", hint: "ÌÉÄÏ°∞, Ï∫•Í±∞Î£®ÏôÄ ÎπÑÏä∑Ìïú ÏÜçÎèÑÏòàÏöî." },
        { question: "Ïö∞Ï£ºÏôïÎ≥µÏÑ†Ïù¥ ÎåÄÍ∏∞Í∂åÏóê Ïû¨ÏßÑÏûÖÌï† Îïå ÏÜçÎ†•ÏùÄ ÏÜåÎ¶¨Ïùò ÏÜçÎ†•(ÎßàÌïò)Ïùò ÏïΩ Î™á Î∞∞ÏùºÍπåÏöî?", options: ["ÎßàÌïò 5", "ÎßàÌïò 10", "ÎßàÌïò 25"], correctAnswer: "ÎßàÌïò 25", hint: "ÏÜåÎ¶¨Î≥¥Îã§ 25Î∞∞ÎÇò Îπ®ÎùºÏöî." },
        { question: "Í≥®ÌîÑÍ≥µÏù¥ ÎìúÎùºÏù¥Î≤ÑÏóê ÎßûÏïòÏùÑ Îïå ÏàúÍ∞Ñ ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["170 km/h", "220 km/h", "270 km/h"], correctAnswer: "270 km/h", hint: "KTX ÏÜçÎèÑÏóê Í±∞Ïùò Ïú°Î∞ïÌï¥Ïöî." },
        { question: "Î≤åÏÉàÏùò ÎÇ†Í∞ØÏßìÏùÄ 1Ï¥àÏóê ÏïΩ Î™á Î≤àÏùºÍπåÏöî?", options: ["10-20Ìöå", "40-50Ìöå", "70-80Ìöå"], correctAnswer: "70-80Ìöå", hint: "ÎààÏóê Î≥¥Ïù¥ÏßÄ ÏïäÏùÑ Ï†ïÎèÑÎ°ú Îπ®ÎùºÏöî." },
        { question: "ÏÇ¨ÎûåÏùò Ïã†Í≤Ω Ïã†Ìò∏ Ï†ÑÎã¨ ÏÜçÎèÑÎäî Ï¥àÏÜç ÏïΩ Î™á mÏùºÍπåÏöî?", options: ["20 m/s", "70 m/s", "120 m/s"], correctAnswer: "120 m/s", hint: "ÏπòÌÉÄÍ∞Ä Îã¨Î¶¨Îäî ÏÜçÎèÑ(ÏïΩ 30m/s)Î≥¥Îã§ 4Î∞∞ Îπ®ÎùºÏöî." },
        { question: "Î∂ÅÍ∑πÍ≥∞Ïùò ÏµúÍ≥† Îã¨Î¶¨Í∏∞ ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["10 km/h", "25 km/h", "40 km/h"], correctAnswer: "40 km/h", hint: "Ïö∞ÏÇ¨Ïù∏ Î≥ºÌä∏Í∞Ä Îõ∞Îäî ÏÜçÎèÑÏôÄ ÎπÑÏä∑Ìï¥Ïöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ Î±ÄÏù∏ Î∏îÎûôÎßòÎ∞îÏùò Ïù¥Îèô ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["5 km/h", "10 km/h", "20 km/h"], correctAnswer: "20 km/h", hint: "ÏûêÏ†ÑÍ±∞Î•º ÌÉÄÍ≥† Ïó¨Ïú†Î°≠Í≤å Îã¨Î¶¨Îäî ÏÜçÎèÑÏòàÏöî." },
        { question: "ÏùºÎ∞òÏ†ÅÏù∏ ÎèÑÏãú ÏûêÏ†ÑÍ±∞ Ï£ºÌñâÏùò ÌèâÍ∑† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["5-10 km/h", "15-20 km/h", "30-35 km/h"], correctAnswer: "15-20 km/h", hint: "ÏÇ¨ÎûåÏù¥ Îõ∞Îäî Í≤ÉÎ≥¥Îã® Ï°∞Í∏à Îπ®ÎùºÏöî." },
        { question: "ÏßÄÍµ¨Ïùò Í≥µÏ†Ñ ÏÜçÎèÑÎäî Ï¥àÏÜç ÏïΩ Î™á kmÏù∏Í∞ÄÏöî?", options: ["30 km/s", "60 km/s", "100 km/s"], correctAnswer: "30 km/s", hint: "1Ï¥àÏóê ÏÑúÏö∏ÏóêÏÑú ÏàòÏõêÍπåÏßÄ Í∞à Ïàò ÏûàÏñ¥Ïöî." },
        { question: "ÌÜ†ÎÅºÍ∞Ä Îã¨Î¶¥ ÎïåÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["35 km/h", "55 km/h", "75 km/h"], correctAnswer: "75 km/h", hint: "Í∑∏Î†àÏù¥ÌïòÏö¥Îìú(Í≤ΩÏ£ºÍ≤¨)ÎßåÌÅº Îπ®ÎùºÏöî." },
        { question: "Ï¥ùÏïåÏùò ÏÜçÎèÑÎäî Î≥¥ÌÜµ ÏùåÏÜçÏùò Î™á Î∞∞ÏùºÍπåÏöî?", options: ["1-3Î∞∞", "5-7Î∞∞", "9-11Î∞∞"], correctAnswer: "1-3Î∞∞", hint: "ÏÜåÎ¶¨Î≥¥Îã§ Ï°∞Í∏à Îçî Îπ†Î•¥Í±∞ÎÇò 3Î∞∞ Ï†ïÎèÑÍπåÏßÄ Îπ®ÎùºÏöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ ÏÉÅÏñ¥Ïù∏ Ï≤≠ÏÉÅÏïÑÎ¶¨Ïùò ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["30 km/h", "50 km/h", "70 km/h"], correctAnswer: "70 km/h", hint: "Î∞îÎã§ ÏÜçÏùò ÏπòÌÉÄÎùºÍ≥† Î∂àÎ¶¥ Ï†ïÎèÑÎäî ÏïÑÎãàÏßÄÎßå ÍΩ§ Îπ®ÎùºÏöî (ÌÉÄÏ°∞ ÏàòÏ§Ä)." },
        { question: "ÌèâÍ∑†Ï†ÅÏù∏ ÏÇ¨ÎûåÏùò Í±∑Îäî ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["1 km/h", "5 km/h", "10 km/h"], correctAnswer: "5 km/h", hint: "1ÏãúÍ∞Ñ Í±∏ÏúºÎ©¥ 5km Ï†ïÎèÑ Í∞ÄÏöî." },
        { question: "Í≥†ÏÜçÎèÑÎ°úÏóêÏÑú ÏûêÎèôÏ∞®Ïùò Î≤ïÏ†ï ÏµúÍ≥† ÏÜçÎèÑÎäî Î≥¥ÌÜµ ÏãúÏÜç Î™á kmÏù∏Í∞ÄÏöî?", options: ["60 km/h", "80 km/h", "110 km/h"], correctAnswer: "110 km/h", hint: "ÏπòÌÉÄÏùò ÏÜçÎèÑÏôÄ Í∞ôÏïÑÏöî." },
        { question: "Ïä§ÌÇ§ Îã§Ïö¥Ìûê ÏÑ†ÏàòÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏóê Ïù¥Î•ºÍπåÏöî?", options: ["60 km/h", "100 km/h", "160 km/h"], correctAnswer: "160 km/h", hint: "ÏïºÍµ¨ Ìà¨ÏàòÏùò Í∞ïÏÜçÍµ¨ ÏÜçÎèÑÏôÄ ÎπÑÏä∑Ìï¥Ïöî." },
        { question: "Í∞ÄÏû• Îπ†Î•∏ Ìï¥Ïñë Ìè¨Ïú†Î•òÏù∏ Î≤îÍ≥†ÎûòÏùò ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["26 km/h", "46 km/h", "56 km/h"], correctAnswer: "56 km/h", hint: "ÏãúÎÇ¥ Ï£ºÌñâ Ï∞®Îüâ ÏÜçÎèÑ(50km/h)Î≥¥Îã§ Ï°∞Í∏à Îπ®ÎùºÏöî." },
        { question: "ÏßÄÍµ¨Ïùò ÏûêÏ†Ñ ÏÜçÎèÑÎäî Ï†ÅÎèÑÏóêÏÑú ÏãúÏÜç ÏïΩ Î™á kmÏù∏Í∞ÄÏöî?", options: ["670 km/h", "1170 km/h", "1670 km/h"], correctAnswer: "1670 km/h", hint: "ÏÜåÎ¶¨Ïùò ÏÜçÎèÑ(ÏïΩ 1200km/h)Î≥¥Îã§ Îçî Îπ®ÎùºÏöî." },
        { question: "ÎåÄÎ•ôÌåêÏùò Ïù¥Îèô ÏÜçÎ†•ÏùÄ 1ÎÖÑÏóê ÏïΩ Î™á cmÏù∏Í∞ÄÏöî?", options: ["2-10cm", "50-60cm", "100-110cm"], correctAnswer: "2-10cm", hint: "ÏÜêÌÜ±Ïù¥ ÏûêÎùºÎäî ÏÜçÎèÑÏôÄ ÎπÑÏä∑Ìï¥Ïöî." },
        { question: "Î∞∞ÎìúÎØºÌÑ¥ ÏÖîÌãÄÏΩïÏùò ÏàúÍ∞Ñ ÏµúÍ≥† ÏÜçÎ†• Í∏∞Î°ùÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["265 km/h", "415 km/h", "565 km/h"], correctAnswer: "565 km/h", hint: "Î™®Îì† Íµ¨Í∏∞ Ï¢ÖÎ™© Ï§ë Í∞ÄÏû• Îπ®ÎùºÏöî." },
        { question: "ÌöåÏò§Î¶¨Î∞îÎûå(ÌÜ†ÎÑ§Ïù¥ÎèÑ)Ïùò Ï§ëÏã¨Î∂Ä ÏµúÎåÄ ÌíçÏÜçÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["200 km/h", "350 km/h", "500 km/h"], correctAnswer: "500 km/h", hint: "KTXÎ≥¥Îã§ Ìõ®Ïî¨ Îπ®ÎùºÏöî." },
        { question: "Í≤ΩÏ£ºÎßàÏùò Îã®Í±∞Î¶¨ ÏµúÍ≥† ÏÜçÎ†•ÏùÄ ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["58 km/h", "78 km/h", "88 km/h"], correctAnswer: "88 km/h", hint: "Í≥†ÏÜçÎèÑÎ°úÎ•º Îã¨Î¶¥ Ïàò ÏûàÏùÑ Ï†ïÎèÑÏòàÏöî." },
        { question: "ÏÇ¨ÎûåÏùò Îàà ÍπúÎπ°ÏûÑ ÏÜçÎèÑÎäî ÏïΩ Î™á Î∞ÄÎ¶¨Ï¥à(ms)ÏùºÍπåÏöî? (1000ms = 1Ï¥à)", options: ["10ms", "50ms", "100ms"], correctAnswer: "100ms", hint: "1Ï¥àÏùò 10Î∂ÑÏùò 1 Ï†ïÎèÑÏòàÏöî." },
        { question: "ÏãúÏÜç 60kmÎäî Î∂ÑÏÜç Î™á kmÏùºÍπåÏöî?", options: ["1km/m", "10km/m", "60km/m"], correctAnswer: "1km/m", hint: "60kmÎ•º 60Î∂Ñ(1ÏãúÍ∞Ñ)Ïóê Í∞ÄÎãàÍπå, 1Î∂ÑÏóêÎäî?" },
        { question: "Ï¥àÏÜç 10mÎäî ÏãúÏÜç Î™á kmÏùºÍπåÏöî?", options: ["16km/h", "26km/h", "36km/h"], correctAnswer: "36km/h", hint: "10 x 3600 / 1000 = ?" },
        { question: "ÏïÑÍ∏∞Í∞Ä Í∏∞Ïñ¥Í∞ÄÎäî ÌèâÍ∑† ÏÜçÎèÑÎäî ÏãúÏÜç ÏïΩ Î™á kmÏùºÍπåÏöî?", options: ["0.5 km/h", "2.5 km/h", "5.5 km/h"], correctAnswer: "0.5 km/h", hint: "Í±∞Î∂ÅÏù¥Î≥¥Îã§Îäî Ï°∞Í∏à Îπ®ÎùºÏöî." },
        { question: "Í∞úÎØ∏Ïùò Ïù¥Îèô ÏÜçÎ†•ÏùÄ Ï¥àÏÜç ÏïΩ Î™á cmÏùºÍπåÏöî?", options: ["1 cm/s", "5 cm/s", "10 cm/s"], correctAnswer: "5 cm/s", hint: "ÏÜêÍ∞ÄÎùΩ Ìïú ÎßàÎîî Ï†ïÎèÑÎ•º 1Ï¥àÏóê Í∞ÄÏöî." },
        { question: "'100 m/s'Îäî Ïñ¥ÎñªÍ≤å ÏùΩÏñ¥Ïïº Ìï†ÍπåÏöî?", options: ["Ï¥àÏÜç 100ÎØ∏ÌÑ∞", "Î∂ÑÏÜç 100ÎØ∏ÌÑ∞", "ÏãúÏÜç 100ÎØ∏ÌÑ∞"], correctAnswer: "Ï¥àÏÜç 100ÎØ∏ÌÑ∞", hint: "'s'Îäî Second(Ï¥à)Î•º ÏùòÎØ∏Ìï¥Ïöî." },
        { question: "'ÏãúÏÜç 30km'Îäî Ïñ¥Îñ§ ÏùòÎØ∏ÏùºÍπåÏöî?", options: ["1Ï¥àÏóê 30kmÎ•º Í∞ÄÎäî ÏÜçÎèÑ", "1Î∂ÑÏóê 30kmÎ•º Í∞ÄÎäî ÏÜçÎèÑ", "1ÏãúÍ∞ÑÏóê 30kmÎ•º Í∞ÄÎäî ÏÜçÎèÑ"], correctAnswer: "1ÏãúÍ∞ÑÏóê 30kmÎ•º Í∞ÄÎäî ÏÜçÎèÑ", hint: "'ÏãúÏÜç'ÏùÄ 1ÏãúÍ∞Ñ Í∏∞Ï§ÄÏù¥ÏóêÏöî." },
        { question: "'5 cm/m'Îäî Î¨¥Ïä® ÎúªÏùºÍπåÏöî?", options: ["1Ï¥àÏóê 5cmÎ•º Í∞ÄÎäî ÏÜçÎèÑ", "1Î∂ÑÏóê 5cmÎ•º Í∞ÄÎäî ÏÜçÎèÑ", "1ÏãúÍ∞ÑÏóê 5cmÎ•º Í∞ÄÎäî ÏÜçÎèÑ"], correctAnswer: "1Î∂ÑÏóê 5cmÎ•º Í∞ÄÎäî ÏÜçÎèÑ", hint: "'/m'ÏóêÏÑú mÏùÄ Minute(Î∂Ñ)ÏùÑ ÏùòÎØ∏Ìï¥Ïöî." },
        { question: "'Î∂ÑÏÜç 1km'Î•º Í∏∞Ìò∏Î°ú Ïñ¥ÎñªÍ≤å ÎÇòÌÉÄÎÇºÍπåÏöî?", options: ["1 km/m", "1 km/s", "1 km/h"], correctAnswer: "1 km/m", hint: "Î∂Ñ(Minute)ÏùÄ 'm'ÏúºÎ°ú Ï§ÑÏó¨ Ïç®Ïöî." },
        { question: "'340 m/s'Îäî ÏÜåÎ¶¨Ïùò ÏÜçÎèÑÏûÖÎãàÎã§. Ïù¥Îäî Î¨¥Ïä® ÏùòÎØ∏ÏùºÍπåÏöî?", options: ["1Ï¥àÏóê 340mÎ•º Ïù¥Îèô", "1Î∂ÑÏóê 340mÎ•º Ïù¥Îèô", "1ÏãúÍ∞ÑÏóê 340mÎ•º Ïù¥Îèô"], correctAnswer: "1Ï¥àÏóê 340mÎ•º Ïù¥Îèô", hint: "'/s'Îäî Ï¥àÎãπ Ïù¥Îèô Í±∞Î¶¨Î•º ÎßêÌï¥Ïöî." },
        { question: "'15 km/h'Îäî Ïñ¥ÎñªÍ≤å ÏùΩÏùÑÍπåÏöî?", options: ["ÏãúÏÜç 15ÌÇ¨Î°úÎØ∏ÌÑ∞", "Î∂ÑÏÜç 15ÌÇ¨Î°úÎØ∏ÌÑ∞", "Ï¥àÏÜç 15ÌÇ¨Î°úÎØ∏ÌÑ∞"], correctAnswer: "ÏãúÏÜç 15ÌÇ¨Î°úÎØ∏ÌÑ∞", hint: "'h'Îäî Hour(ÏãúÍ∞Ñ)Î•º ÏùòÎØ∏Ìï¥Ïöî." },
        { question: "'1Ï¥àÏóê 1mÎ•º Í∞ÄÎäî ÏÜçÎèÑ'Î•º Í∏∞Ìò∏Î°ú Ïñ¥ÎñªÍ≤å ÎÇòÌÉÄÎÇºÍπåÏöî?", options: ["1 m/s", "1 m/m", "1 km/s"], correctAnswer: "1 m/s", hint: "ÎØ∏ÌÑ∞(m) ÎÇòÎàÑÍ∏∞ Ï¥à(s)." },
        { question: "ÏßÄÍµ¨Ïùò Í≥µÏ†Ñ ÏÜçÎèÑÎäî ÏïΩ '30 km/s'ÏûÖÎãàÎã§. Ïñ¥ÎñªÍ≤å ÏùΩÏñ¥Ïïº Ìï†ÍπåÏöî?", options: ["Ï¥àÏÜç 30ÌÇ¨Î°úÎØ∏ÌÑ∞", "Î∂ÑÏÜç 30ÌÇ¨Î°úÎØ∏ÌÑ∞", "ÏãúÏÜç 30ÌÇ¨Î°úÎØ∏ÌÑ∞"], correctAnswer: "Ï¥àÏÜç 30ÌÇ¨Î°úÎØ∏ÌÑ∞", hint: "'/s'Îäî Ï¥àÏÜçÏù¥ÏóêÏöî." },
        { question: "'1ÏãúÍ∞ÑÏóê 900kmÎ•º Í∞ÄÎäî ÏÜçÎèÑ'Îäî ÎπÑÌñâÍ∏∞Ïùò ÌèâÍ∑† ÏÜçÎèÑÏûÖÎãàÎã§. Í∏∞Ìò∏Î°ú Ïñ¥ÎñªÍ≤å ÌëúÌòÑÌï†ÍπåÏöî?", options: ["900 km/h", "900 m/h", "900 km/s"], correctAnswer: "900 km/h", hint: "ÏãúÍ∞ÑÏùÄ 'h'Î°ú Ïç®Ïöî." },
        { question: "'Î∂ÑÏÜç 800m'Îäî Î¨¥Ïä® ÎúªÏùºÍπåÏöî?", options: ["1Ï¥àÏóê 800mÎ•º Í∞ÄÎäî ÏÜçÎèÑ", "1Î∂ÑÏóê 800mÎ•º Í∞ÄÎäî ÏÜçÎèÑ", "1ÏãúÍ∞ÑÏóê 800mÎ•º Í∞ÄÎäî ÏÜçÎèÑ"], correctAnswer: "1Î∂ÑÏóê 800mÎ•º Í∞ÄÎäî ÏÜçÎèÑ", hint: "Î∂ÑÏÜçÏùÄ 1Î∂Ñ ÎèôÏïà Í∞Ñ Í±∞Î¶¨Î•º ÎßêÌï¥Ïöî." }
    ];

    function getQuizQuestions() {
        // Deep copy and shuffle
        const array = JSON.parse(JSON.stringify(allQuestions));
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- SERVICE: SOUND ---
    class SoundService {
        constructor() {
            this.audioContext = null;
            this.isEnabled = true;
            this.currentBgmType = null;
            this.isBgmPlaying = false;
            this.nextNoteTime = 0;
            this.noteIndex = 0;
            this.schedulerTimer = null;
            this.bgmGainNode = null;
        }

        getContext() {
            if (!this.audioContext) {
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContextClass();
                } catch (e) {
                    console.error("Web Audio API not supported");
                    this.isEnabled = false;
                }
            }
            return this.audioContext;
        }

        async resumeContext() {
            const context = this.getContext();
            if (context && context.state === 'suspended') {
                await context.resume();
            }
        }

        playTone(frequency, duration, type = 'sine', onEnded) {
            const context = this.getContext();
            if (!context || !this.isEnabled) return;

            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, context.currentTime);
            
            gainNode.gain.setValueAtTime(0.2, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            oscillator.start();
            oscillator.stop(context.currentTime + duration);
            if(onEnded) {
                oscillator.onended = onEnded;
            }
        }

        playBGM(type) {
            const context = this.getContext();
            if (!context || !this.isEnabled) return;

            if (this.currentBgmType === type && this.isBgmPlaying) return;

            this.stopBGM();
            this.currentBgmType = type;
            this.isBgmPlaying = true;
            this.noteIndex = 0;
            this.nextNoteTime = context.currentTime + 0.1;
            
            this.bgmGainNode = context.createGain();
            this.bgmGainNode.gain.value = 0.1;
            this.bgmGainNode.connect(context.destination);

            this.scheduleNextNote();
        }

        stopBGM() {
            this.isBgmPlaying = false;
            this.currentBgmType = null;
            if (this.schedulerTimer) {
                window.clearTimeout(this.schedulerTimer);
                this.schedulerTimer = null;
            }
            if (this.bgmGainNode) {
                this.bgmGainNode.disconnect();
                this.bgmGainNode = null;
            }
        }

        scheduleNextNote() {
            const context = this.getContext();
            if (!context || !this.isBgmPlaying) return;

            const lookahead = 25.0; 
            const scheduleAheadTime = 0.1;

            while (this.nextNoteTime < context.currentTime + scheduleAheadTime) {
                this.playBGMNote(this.nextNoteTime);
                this.advanceNote();
            }

            this.schedulerTimer = window.setTimeout(() => {
                this.scheduleNextNote();
            }, lookahead);
        }

        advanceNote() {
            const tempo = this.currentBgmType === 'battle' ? 160 : 120;
            const secondsPerBeat = 60.0 / tempo;
            this.nextNoteTime += 0.5 * secondsPerBeat;
            this.noteIndex++;
        }

        playBGMNote(time) {
            const context = this.getContext();
            if (!context || !this.bgmGainNode) return;

            const osc = context.createOscillator();
            const noteGain = context.createGain();
            
            osc.connect(noteGain);
            noteGain.connect(this.bgmGainNode);

            let freq = 0;

            if (this.currentBgmType === 'menu') {
                osc.type = 'triangle';
                const sequence = [
                    261.63, 329.63, 392.00, 493.88, 523.25, 493.88, 392.00, 329.63,
                    349.23, 440.00, 523.25, 659.25, 698.46, 659.25, 523.25, 440.00
                ];
                freq = sequence[this.noteIndex % sequence.length];
                noteGain.gain.setValueAtTime(0.1, time);
                noteGain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
            } else if (this.currentBgmType === 'battle') {
                osc.type = 'sawtooth';
                const sequence = [
                    220.00, 220.00, 329.63, 220.00, 196.00, 196.00, 261.63, 196.00,
                    174.61, 174.61, 220.00, 174.61, 164.81, 164.81, 196.00, 164.81
                ];
                freq = sequence[this.noteIndex % sequence.length];
                noteGain.gain.setValueAtTime(0.1, time);
                noteGain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
            }

            if (freq > 0) {
                osc.frequency.value = freq;
                osc.start(time);
                osc.stop(time + 0.3);
            }
        }

        playClickSound() { this.playTone(800, 0.05, 'triangle'); }
        playPlayerAttackSound() { this.playTone(523.25, 0.1, 'square', () => this.playTone(783.99, 0.15, 'square')); }
        playOpponentAttackSound() { this.playTone(110, 0.15, 'sawtooth', () => this.playTone(98, 0.2, 'sawtooth')); }
        playVictorySound() {
            this.stopBGM();
            this.playTone(523.25, 0.15, 'square', () => 
                this.playTone(659.26, 0.15, 'square', () => 
                    this.playTone(783.99, 0.15, 'square', () =>
                        this.playTone(1046.50, 0.6, 'square')
                    )
                )
            );
        }
        playDefeatSound() {
            this.stopBGM();
            const context = this.getContext();
            if (!context) return;
            const osc = context.createOscillator();
            const gain = context.createGain();
            osc.connect(gain);
            gain.connect(context.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, context.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, context.currentTime + 1);
            gain.gain.setValueAtTime(0.2, context.currentTime);
            gain.gain.linearRampToValueAtTime(0, context.currentTime + 1);
            osc.start();
            osc.stop(context.currentTime + 1);
        }
    }
    const soundService = new SoundService();

    // --- COMPONENTS: ICONS ---
    const SpeedometerIcon = ({ className }) => (
        <svg className={className} viewBox="0 0 100 60" fill="none">
            <path d="M10 50 A 40 40 0 0 1 90 50" stroke="#a5b4fc" strokeWidth="4" strokeLinecap="round" />
            <path d="M10 50 A 40 40 0 0 1 90 50" stroke="url(#speedo-gradient)" strokeWidth="4" strokeLinecap="round" />
            <defs><linearGradient id="speedo-gradient" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#818cf8" /><stop offset="100%" stopColor="#3b82f6" /></linearGradient></defs>
            {Array.from({ length: 9 }).map((_, i) => <line key={i} x1={50 + 40 * Math.cos((-160 + i * 17.5) * Math.PI / 180)} y1={50 + 40 * Math.sin((-160 + i * 17.5) * Math.PI / 180)} x2={50 + 35 * Math.cos((-160 + i * 17.5) * Math.PI / 180)} y2={50 + 35 * Math.sin((-160 + i * 17.5) * Math.PI / 180)} stroke="white" strokeWidth="2" strokeLinecap="round" />)}
            <g transform="rotate(20 50 50)"><path d="M50 50 L 20 47" stroke="white" strokeWidth="3" strokeLinecap="round"/><circle cx="50" cy="50" r="4" fill="white"/></g>
            <path d="M52 49 L48 35 L54 35 L48 20 L51 19 L60 39 L54 39 L58 49 Z" fill="#3b82f6"/>
        </svg>
    );
    const TimerIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" fill="#1f2937" stroke="#4ade80" /><path d="M12 6V12L16 14" stroke="white" fill="none" /></svg>);
    const CheckIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6L9 17l-5-5" /></svg>);
    const XIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6L6 18" /><path d="M6 6l12 12" /></svg>);
    const LightBulbIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18h6" /><path d="M10 22h4" /><path d="M12 2v1" /><path d="M12 15a7 7 0 1 0-7-7c0 1.333.333 2.667 1 4" /><path d="M21 8a7 7 0 0 0-2-4.9" /></svg>);
    const FistIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="currentColor"><path d="M20.2 14.1c-1.3 0-2.5.6-3.5 1.6l-1.6 1.6-1.6-1.6c-1-1-2.2-1.6-3.5-1.6-1.3 0-2.5.6-3.5 1.6l-1.5 1.5v-8.7c0-2.2 1.8-4 4-4 1.4 0 2.6.7 3.3 1.8.7-1.1 1.9-1.8 3.3-1.8 2.2 0 4 1.8 4 4v5.6l-1.4 1.4c0-.8 1-1.8 1.5-1.8zM10 19.8l1.4-1.4 1.4 1.4c.4.4 1 .4 1.4 0l1.4-1.4 1.4 1.4c1.2 1.2 3.1 1.2 4.2 0l.7-.7v-8.6c0-1.1-.9-2-2-2s-2 .9-2 2v4h-2v-4c0-1.1-.9-2-2-2s-2 .9-2 2v6.8l-1.3-1.3c-.8-.8-2.1-.8-2.8 0l-1.4 1.4c-1.2 1.2-1.2 3.1 0 4.2l3.4 3.4c.4.4 1 .4 1.4 0z"/></svg>);
    const PotionIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1"><path d="M10 2v3h4V2h-4zM7 6v2c0 4.4 3 8.2 7 9.2V6H7zm10 0h-1v11.2c4-.9 7-4.7 7-9.2V6h-6zM12 18c-3.3 0-6-2.7-6-6v-1H4v1c0 4.4 3.6 8 8 8s8-3.6 8-8v-1h-2v1c0 3.3-2.7 6-6 6z" opacity="0.8"/><path d="M12 22c4.4 0 8-3.6 8-8h-2c0 3.3-2.7 6-6 6s-6-2.7-6-6H4c0 4.4 3.6 8 8 8z"/></svg>);
    const ShieldIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>);
    const SwordIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M14.5 17.5L3 6V3h3l11.5 11.5-3 3zM15 15l6 6 2-2-6-6-2 2z"/><path d="M19 6l-9 9-2-2 9-9 2 2z"/></svg>);

    // --- COMPONENTS: SCREENS ---

    const StartScreen = ({ onStart }) => (
        <div className="flex flex-col items-center justify-between h-full text-white p-8 text-center">
            <div className="flex-grow flex flex-col items-center justify-center">
                <SpeedometerIcon className="w-48 h-auto mb-8" />
                <h1 className="text-5xl font-bold mb-2">ÏÜçÎ†• ÌÄ¥Ï¶à</h1>
                <p className="text-lg text-gray-200">ÏãúÍ∞ÑÍ≥ºÏùò Í≤ΩÏ£º, ÏÜçÎ†•ÏùÑ ÎßûÌòÄÎùº!</p>
            </div>
            <button onClick={onStart} className="w-full max-w-sm text-2xl font-bold py-4 px-8 rounded-full bg-gradient-to-b from-blue-400 to-blue-600 text-white border-2 border-blue-300 shadow-lg active:scale-95 transition-transform hover:scale-105">ÏãúÏûëÌïòÍ∏∞</button>
        </div>
    );

    const CharacterSelectionScreen = ({ onCharacterSelect, lockedCharacters }) => (
        <div className="flex flex-col items-center justify-center h-full text-white p-4 text-center">
            <h1 className="text-4xl font-bold mb-1">ÌååÌä∏ÎÑà ÏÑ†ÌÉù</h1>
            <p className="text-lg text-gray-300 mb-6">Ìï®Íªò ÌÄ¥Ï¶à Î∞∞ÌãÄÏóê ÎÇòÏÑ§ ÌååÌä∏ÎÑàÎ•º Í≥®ÎùºÏ£ºÏÑ∏Ïöî!</p>
            <div className="w-full grid grid-cols-3 gap-3 md:gap-4 flex-grow overflow-y-auto content-start">
                {characters.map((char) => {
                    const isLocked = lockedCharacters.includes(char.name);
                    return (
                        <button key={char.name} onClick={() => !isLocked && onCharacterSelect(char)} disabled={isLocked} className={`relative rounded-2xl p-2 flex flex-col items-center justify-center transition-all duration-300 aspect-square border-2 border-transparent ${isLocked ? 'bg-gray-800/50 opacity-50 grayscale cursor-not-allowed' : 'bg-white/10 hover:bg-white/20 hover:scale-105 cursor-pointer hover:border-white/50'}`}>
                            <img src={char.image} alt={char.name} className="w-full h-auto object-contain flex-grow" />
                            <p className="font-bold text-sm mt-2">{char.name}</p>
                            {isLocked && <div className="absolute inset-0 flex items-center justify-center bg-black/60 rounded-2xl z-10"><span className="text-4xl">üîí</span></div>}
                        </button>
                    );
                })}
            </div>
        </div>
    );

    const ResultsScreen = ({ userAnswers, onRestart, player, opponent, playerHP, opponentHP }) => {
        const isVictory = playerHP > opponentHP;
        useEffect(() => { isVictory ? soundService.playVictorySound() : soundService.playDefeatSound(); }, [isVictory]);
        const totalScore = userAnswers.reduce((total, answer) => total + answer.score, 0);
        const correctAnswers = userAnswers.filter(answer => answer.isCorrect).length;

        return (
            <div className="relative flex flex-col items-center justify-between h-full p-6 text-center overflow-hidden">
                {isVictory && Array.from({ length: 50 }).map((_, i) => (
                    <div key={i} className="absolute w-3 h-4 opacity-70 rounded-full" style={{ left: `${Math.random() * 100}%`, top: `${-20 + Math.random() * 40}%`, transform: `rotate(${Math.random() * 360}deg)`, animation: `fall ${3 + Math.random() * 5}s ${Math.random() * 5}s linear infinite`, backgroundColor: ['#facc15', '#4ade80', '#60a5fa', '#f87171'][i % 4] }}></div>
                ))}
                <div className="z-10 flex-grow w-full max-w-md flex flex-col items-center justify-center">
                    <h1 className={`text-6xl font-bold text-white drop-shadow-lg mb-4 ${isVictory ? 'text-yellow-300' : 'text-slate-400'}`}>{isVictory ? "ÏäπÎ¶¨!" : "Ìå®Î∞∞"}</h1>
                    <div className="relative w-full h-48 flex justify-center items-center mb-6">
                        <div className={`absolute left-0 transition-opacity duration-1000 ${!isVictory ? 'opacity-40' : ''}`}>
                            <img src={player.image} alt={player.name} className="h-40 object-contain float-anim" />
                            <p className="text-white font-bold mt-1">{player.name}</p>
                            <p className="text-lg font-bold text-green-300">{`HP: ${playerHP}`}</p>
                        </div>
                        <span className="text-4xl font-bold text-white mx-8">VS</span>
                        <div className={`absolute right-0 transition-opacity duration-1000 ${isVictory ? 'opacity-40' : ''}`}>
                            <img src={opponent.image} alt={opponent.name} className="h-40 object-contain" />
                            <p className="text-white font-bold mt-1">{opponent.name}</p>
                            <p className={`text-lg font-bold ${opponentHP > 0 ? 'text-green-300' : 'text-red-400'}`}>{`HP: ${opponentHP}`}</p>
                        </div>
                    </div>
                    <div className="bg-black/20 backdrop-blur-sm rounded-xl p-4 w-full">
                        <p className="text-2xl font-semibold text-white/90 drop-shadow-md">Ï¥ù {totalScore}Ï†ê ÌöçÎìù</p>
                        <p className="text-white/80">{`Ï†ïÎãµ: ${correctAnswers} / ${userAnswers.length}`}</p>
                    </div>
                </div>
                <div className="z-10 w-full max-w-sm mt-6">
                    <button onClick={onRestart} className="w-full text-2xl font-bold py-4 px-8 rounded-full bg-gradient-to-b from-blue-400 to-blue-600 text-white border-2 border-blue-300 shadow-lg active:scale-95 transition-transform hover:scale-105">Îã§Ïãú ÎèÑÏ†Ñ</button>
                </div>
            </div>
        );
    };

    // --- COMPONENT: QUIZ SCREEN ---
    const HPBar = ({ hp, maxHp, isPlayer }) => {
        const percentage = Math.max(0, Math.min(100, (hp / maxHp) * 100));
        let barColor = 'bg-green-500';
        if (percentage < 50) barColor = 'bg-yellow-500';
        if (percentage < 25) barColor = 'bg-red-500';
        return (
            <div className={`w-full bg-gray-700 rounded-full h-3 md:h-4 border-2 ${isPlayer ? 'border-gray-500' : 'border-gray-400'} shadow-inner`}>
                <div className={`h-full rounded-full ${barColor} transition-all duration-500`} style={{ width: `${percentage}%` }}></div>
            </div>
        );
    };

    const BattleBackground = ({ theme }) => {
        const Sun = () => (<><div className="absolute top-[-20px] left-[-20px] w-32 h-32 bg-yellow-200/40 rounded-full blur-2xl"></div><div className="absolute top-4 left-4 w-16 h-16 bg-yellow-300/80 rounded-full blur-md"></div></>);
        const Moon = () => (<><div className="absolute top-4 right-4 w-16 h-16 bg-slate-100 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.5)]"></div><div className="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPjxjaXJjbGUgY3g9IjEiIGN5PSIxIiByPSIxIiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC4zIi8+PC9zdmc+')] opacity-30"></div></>);

        switch(theme) {
            case 'volcano': return <><div className="absolute bottom-[20%] left-0 w-full h-[50%] bg-red-900/40"></div><div className="absolute bottom-[20%] left-[-10%] w-full h-[60%] bg-red-900/50 rounded-tr-[100%] transform rotate-3 scale-y-75"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-red-800 to-orange-900 rounded-[50%] border-t-4 border-orange-500/50 shadow-[0_-10px_30px_rgba(255,50,0,0.3)]"><div className="absolute bottom-0 w-full h-full opacity-30 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-yellow-500 to-transparent animate-pulse"></div></div><div className="absolute top-0 w-full h-full bg-orange-500/10 mix-blend-overlay"></div><div className="absolute bottom-[15%] right-[20%] w-4 h-20 bg-orange-500 blur-md opacity-60"></div></>;
            case 'ocean': return <><Sun /><div className="absolute bottom-[25%] w-full h-[35%] bg-gradient-to-t from-blue-600 to-cyan-400 opacity-50"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-blue-500 to-blue-800 rounded-[50%] border-t-4 border-cyan-200/50 shadow-[0_-10px_30px_rgba(0,0,255,0.2)]"><div className="absolute top-4 left-20 w-40 h-2 bg-white/20 rounded-full blur-sm"></div><div className="absolute top-8 right-20 w-32 h-2 bg-white/10 rounded-full blur-sm"></div></div><div className="absolute bottom-10 left-10 w-4 h-4 bg-white/30 rounded-full animate-bounce"></div><div className="absolute bottom-20 right-10 w-2 h-2 bg-white/30 rounded-full animate-bounce"></div></>;
            case 'forest': return <><Sun /><div className="absolute bottom-[25%] left-[5%] w-0 h-0 border-l-[30px] border-l-transparent border-r-[30px] border-r-transparent border-b-[100px] border-b-green-900"></div><div className="absolute bottom-[25%] right-[10%] w-0 h-0 border-l-[40px] border-l-transparent border-r-[40px] border-r-transparent border-b-[120px] border-b-green-800"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-emerald-700 to-green-900 rounded-[50%] border-t-4 border-green-500/30 shadow-[0_-10px_30px_rgba(0,0,0,0.4)]"></div></>;
            case 'moon': return <><Moon /><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-indigo-800 to-purple-950 rounded-[50%] border-t-4 border-indigo-400/30 shadow-[0_-10px_30px_rgba(0,0,0,0.6)]"><div className="absolute top-[10%] left-[20%] w-2 h-2 bg-white/40 rounded-full blur-[1px]"></div><div className="absolute top-[20%] right-[30%] w-2 h-2 bg-white/40 rounded-full blur-[1px]"></div></div></>;
            case 'graveyard': return <><Moon /><div className="absolute bottom-[25%] left-[15%] w-10 h-16 bg-gray-800 rounded-t-md opacity-80"></div><div className="absolute bottom-[25%] right-[20%] w-12 h-20 bg-gray-900 rounded-t-md opacity-90"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-gray-800 to-black rounded-[50%] border-t-4 border-purple-900/40 shadow-[0_-10px_30px_rgba(0,0,0,0.8)]"></div><div className="absolute bottom-[20%] w-full h-[30%] bg-black/20 blur-xl"></div></>;
            case 'stage': return <><div className="absolute top-[-20%] left-1/2 -translate-x-1/2 w-[80%] h-[100%] bg-pink-500/20 blur-3xl rounded-full"></div><div className="absolute top-[-10%] left-[10%] w-20 h-[120%] bg-white/10 rotate-12 blur-xl"></div><div className="absolute top-[-10%] right-[10%] w-20 h-[120%] bg-white/10 -rotate-12 blur-xl"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-pink-500 to-purple-700 rounded-[50%] border-t-4 border-pink-300/50 shadow-[0_-10px_30px_rgba(255,192,203,0.3)]"></div></>;
            case 'garden': return <><Sun /><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-lime-400 to-green-600 rounded-[50%] border-t-4 border-yellow-200/50 shadow-[0_-10px_30px_rgba(0,0,0,0.2)]"><div className="absolute top-4 left-[20%] w-4 h-4 bg-pink-400 rounded-full"></div><div className="absolute top-6 right-[25%] w-4 h-4 bg-yellow-400 rounded-full"></div><div className="absolute top-2 left-[40%] w-4 h-4 bg-white rounded-full"></div></div></>;
            case 'mountain': return <><Sun /><div className="absolute bottom-[20%] left-[-10%] w-full h-[60%] bg-slate-600 rounded-tr-[100%] transform rotate-6 scale-y-75"></div><div className="absolute bottom-[20%] right-[-10%] w-full h-[50%] bg-slate-700 rounded-tl-[100%] transform -rotate-3 scale-y-75"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-slate-500 to-slate-800 rounded-[50%] border-t-4 border-slate-400/50 shadow-[0_-10px_30px_rgba(0,0,0,0.3)]"></div></>;
            default: return <><Sun /><div className="absolute top-[15%] left-[20%] w-24 h-8 bg-white/40 rounded-full blur-sm opacity-80"></div><div className="absolute top-[10%] right-[10%] w-32 h-10 bg-white/30 rounded-full blur-md opacity-60"></div><div className="absolute bottom-[20%] left-[-20%] w-[80%] h-[50%] bg-indigo-900/10 rounded-tr-full transform rotate-6 scale-y-50"></div><div className="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[150%] h-[45%] bg-gradient-to-b from-[#4ade80] to-[#15803d] rounded-[50%] border-t-4 border-green-300/50 shadow-[0_-10px_30px_rgba(0,0,0,0.2)]"></div></>;
        }
    };

    const MiniGameOverlay = ({ onComplete }) => {
        const [timeLeft, setTimeLeft] = useState(5);
        const [clicks, setClicks] = useState(0);
        const [phase, setPhase] = useState('intro');

        useEffect(() => {
            let timer;
            if (phase === 'playing' && timeLeft > 0) {
                timer = window.setInterval(() => setTimeLeft(p => p - 1), 1000);
            } else if (phase === 'playing' && timeLeft === 0) {
                setPhase('result');
            }
            return () => clearInterval(timer);
        }, [phase, timeLeft]);

        useEffect(() => {
            if (phase === 'result') {
                const timer = setTimeout(() => setPhase('choice'), 2500);
                return () => clearTimeout(timer);
            }
        }, [phase]);

        const handleClick = () => {
            if (phase === 'playing' && timeLeft > 0) {
                soundService.playClickSound();
                setClicks(p => p + 1);
            }
        };

        const handleChoice = (action) => {
            soundService.playClickSound();
            onComplete(clicks, action);
        };

        const power = Math.min(25, Math.floor(clicks * 0.8));

        return (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
                {phase === 'intro' && (
                    <div className="text-center flex flex-col items-center">
                        <div className="h-32 flex items-end mb-6"><h2 className="text-4xl font-bold text-yellow-400 animate-bounce">ÌûòÍ≤®Î£®Í∏∞!</h2></div>
                        <p className="text-xl text-white mb-8 animate-pulse">Î≤ÑÌäºÏùÑ Îπ†Î•¥Í≤å Ïó∞ÌÉÄÌï¥ÏÑú<br/>ÌûòÏùÑ Î™®ÏúºÏÑ∏Ïöî!</p>
                        <button onClick={() => setPhase('playing')} className="bg-red-500 text-white font-bold py-4 px-10 rounded-full text-2xl border-4 border-red-300 shadow-lg active:scale-95 hover:bg-red-600 transition-colors">Ï§ÄÎπÑ ÏôÑÎ£å!</button>
                    </div>
                )}
                {phase === 'playing' && (
                    <div className="text-center w-full max-w-xs">
                        <div className="mb-4 flex justify-between text-white text-2xl font-bold"><span>ÏãúÍ∞Ñ: {timeLeft}Ï¥à</span><span>Ï†êÏàò: {clicks}</span></div>
                        <div className="w-full bg-gray-700 rounded-full h-6 mb-8"><div className="bg-yellow-400 h-6 rounded-full transition-all duration-100" style={{ width: `${(timeLeft/5)*100}%` }}></div></div>
                        <button onClick={handleClick} className="w-48 h-48 rounded-full bg-gradient-to-r from-red-500 to-orange-600 border-8 border-white shadow-[0_0_20px_rgba(255,0,0,0.5)] flex items-center justify-center active:scale-95 transition-transform mx-auto cursor-pointer" style={{ touchAction: 'manipulation' }}><FistIcon className="w-24 h-24 text-white" /></button>
                    </div>
                )}
                {phase === 'result' && (
                    <div className="text-center animate-pulse"><h2 className="text-5xl font-bold text-yellow-300 mb-4">ÏãúÍ∞Ñ Ï¢ÖÎ£å!</h2><p className="text-3xl text-white font-bold">ÌöçÎìù Ï†êÏàò: {clicks}Ï†ê</p><p className="text-2xl text-gray-300 mt-2">Ìûò(Power): {power}</p></div>
                )}
                {phase === 'choice' && (
                    <div className="text-center w-full max-w-md"><h2 className="text-3xl font-bold text-white mb-6">ÌûòÏùÑ Ïñ¥ÎîîÏóê Ïì∏ÍπåÏöî?</h2>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => handleChoice('heal')} className="flex flex-col items-center justify-center bg-green-500 hover:bg-green-600 text-white p-6 rounded-2xl border-4 border-green-300 shadow-lg transition-transform active:scale-95"><PotionIcon className="w-12 h-12 mb-2" /><span className="text-2xl font-bold">HP ÌöåÎ≥µ</span><span className="text-sm opacity-80">+{power} HP</span></button>
                            <button onClick={() => handleChoice('attack')} className="flex flex-col items-center justify-center bg-red-500 hover:bg-red-600 text-white p-6 rounded-2xl border-4 border-red-300 shadow-lg transition-transform active:scale-95"><SwordIcon className="w-12 h-12 mb-2" /><span className="text-2xl font-bold">Ï†Å Í≥µÍ≤©</span><span className="text-sm opacity-80">-{power} HP</span></button>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const QuizScreen = ({ questions, player, opponent, onComplete }) => {
        const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [userAnswers, setUserAnswers] = useState([]);
        const [timeLeft, setTimeLeft] = useState(15);
        const [playerHP, setPlayerHP] = useState(100);
        const [opponentHP, setOpponentHP] = useState(100);
        const [playerHit, setPlayerHit] = useState(false);
        const [opponentHit, setOpponentHit] = useState(false);
        const [playerDamage, setPlayerDamage] = useState(0);
        const [opponentDamage, setOpponentDamage] = useState(0);
        const [showHint, setShowHint] = useState(false);
        const [streak, setStreak] = useState(0);
        const [items, setItems] = useState([]);
        const [usedItemMessage, setUsedItemMessage] = useState(null);
        const [showMiniGame, setShowMiniGame] = useState(false);
        const timerRef = useRef(null);
        const currentQuestion = questions[currentQuestionIndex];

        useEffect(() => {
            if (!showHint && !showMiniGame && selectedAnswer === null) startTimer();
            else clearInterval(timerRef.current);
            return () => clearInterval(timerRef.current);
        }, [currentQuestionIndex, showHint, showMiniGame, selectedAnswer]);

        const startTimer = () => {
            clearInterval(timerRef.current);
            timerRef.current = setInterval(() => {
                setTimeLeft(prev => { if (prev <= 1) { handleTimeUp(); return 0; } return prev - 1; });
            }, 1000);
        };

        useEffect(() => setTimeLeft(15), [currentQuestionIndex]);

        const handleTimeUp = () => handleNextQuestion(null);

        const handleAnswerSelect = (answer) => {
            if (selectedAnswer !== null) return;
            soundService.playClickSound();
            clearInterval(timerRef.current);
            setSelectedAnswer(answer);
            setTimeout(() => handleNextQuestion(answer), 1500);
        };

        const handleUseItem = (item) => {
            soundService.playClickSound();
            setUsedItemMessage(`${item.name} ÏÇ¨Ïö©!`);
            setTimeout(() => setUsedItemMessage(null), 1500);
            if (item.type === 'heal') { setPlayerHP(p => Math.min(100, p + 30)); setPlayerDamage(-30); setPlayerHit(true); }
            else if (item.type === 'shield') { setPlayerHP(p => Math.min(100, p + 20)); setPlayerDamage(-20); setPlayerHit(true); }
            else if (item.type === 'attack') { setOpponentHP(p => Math.max(0, p - 20)); setOpponentDamage(20); setOpponentHit(true); soundService.playPlayerAttackSound(); }
            setTimeout(() => { setPlayerHit(false); setPlayerDamage(0); setOpponentHit(false); setOpponentDamage(0); }, 1000);
            setItems(prev => prev.filter(i => i.id !== item.id));
        };

        const handleNextQuestion = (answer) => {
            clearInterval(timerRef.current);
            if (selectedAnswer === null) setSelectedAnswer(answer || "ÏãúÍ∞Ñ Ï¥àÍ≥º");
            const isCorrect = answer === currentQuestion.correctAnswer;
            let nextPlayerHP = playerHP;
            let nextOpponentHP = opponentHP;
            let nextStreak = streak;

            if (isCorrect) {
                soundService.playPlayerAttackSound();
                nextOpponentHP = Math.max(0, opponentHP - 10);
                setOpponentHP(nextOpponentHP);
                setOpponentDamage(10);
                setOpponentHit(true);
                nextStreak += 1;
                if (nextStreak >= 2) {
                    const itemTypes = ['heal', 'shield', 'attack'];
                    const randomType = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                    let newItem;
                    const itemId = Date.now().toString() + Math.random().toString().slice(2, 6);
                    if (randomType === 'heal') newItem = { id: itemId, name: 'Î¨ºÏïΩ', type: 'heal', icon: <PotionIcon className="w-8 h-8 text-red-500" /> };
                    else if (randomType === 'shield') newItem = { id: itemId, name: 'Î∞©Ìå®', type: 'shield', icon: <ShieldIcon className="w-8 h-8 text-blue-500" /> };
                    else newItem = { id: itemId, name: 'Í≤Ä', type: 'attack', icon: <SwordIcon className="w-8 h-8 text-gray-600" /> };
                    setItems(prev => [...prev, newItem]);
                    nextStreak = 0;
                }
                setStreak(nextStreak);
                setTimeout(() => { setOpponentHit(false); setOpponentDamage(0); }, 500);
            } else {
                soundService.playOpponentAttackSound();
                nextPlayerHP = Math.max(0, playerHP - 10);
                setPlayerHP(nextPlayerHP);
                setPlayerDamage(10);
                setPlayerHit(true);
                setStreak(0);
                setTimeout(() => { setPlayerHit(false); setPlayerDamage(0); }, 500);
            }

            const newAnswer = { question: currentQuestion.question, selectedAnswer: answer || 'ÏãúÍ∞Ñ Ï¥àÍ≥º', isCorrect, correctAnswer: currentQuestion.correctAnswer, score: isCorrect ? 50 + Math.floor(timeLeft * 3.33) : 0 };
            const updatedAnswers = [...userAnswers, newAnswer];
            setUserAnswers(updatedAnswers);

            setTimeout(() => {
                const nextIndex = currentQuestionIndex + 1;
                if (nextIndex === 5) {
                    setShowMiniGame(true);
                } else if (nextIndex < questions.length) {
                    setCurrentQuestionIndex(nextIndex);
                    setSelectedAnswer(null);
                    setShowHint(false);
                } else {
                    onComplete(updatedAnswers, nextPlayerHP, nextOpponentHP);
                }
            }, 1000);
        };

        const handleMiniGameComplete = (score, action) => {
            setShowMiniGame(false);
            const power = Math.min(25, Math.floor(score * 0.8));
            if (power > 0) {
                if (action === 'heal') {
                    soundService.playClickSound();
                    setPlayerHP(p => Math.min(100, p + power));
                    setPlayerDamage(-power);
                    setPlayerHit(true);
                    setTimeout(() => { setPlayerHit(false); setPlayerDamage(0); }, 1000);
                } else {
                    soundService.playPlayerAttackSound();
                    setOpponentHP(p => Math.max(0, p - power));
                    setOpponentDamage(power);
                    setOpponentHit(true);
                    setTimeout(() => { setOpponentHit(false); setOpponentDamage(0); }, 1000);
                }
            }
            if (currentQuestionIndex + 1 < questions.length) {
                setCurrentQuestionIndex(p => p + 1);
                setSelectedAnswer(null);
                setShowHint(false);
            } else {
                onComplete(userAnswers, playerHP, opponentHP);
            }
        };

        const getButtonClass = (option) => {
            let classes = 'bg-white/80 text-slate-800 border-gray-300';
            if (selectedAnswer === null) return `${classes} hover:bg-white hover:border-blue-400`;
            if (option === currentQuestion.correctAnswer) return 'bg-green-100 text-green-800 border-green-500 animate-pulse';
            if (option === selectedAnswer) return 'bg-red-100 text-red-800 border-red-500';
            return `${classes} opacity-60`;
        };

        return (
            <div className="relative flex flex-col h-full text-white overflow-hidden">
                {showMiniGame && <MiniGameOverlay onComplete={handleMiniGameComplete} />}
                {showHint && (
                    <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-6 cursor-pointer" onClick={() => setShowHint(false)}>
                        <div className="bg-white text-slate-800 rounded-2xl p-6 max-w-md w-full shadow-2xl border-4 border-yellow-300 popup-anim relative">
                            <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-yellow-300 rounded-full p-3 shadow-lg border-4 border-white"><LightBulbIcon className="w-8 h-8 text-yellow-800" /></div>
                            <div className="mt-8 text-center"><h3 className="text-2xl font-bold text-yellow-600 mb-4">ÌûåÌä∏</h3><p className="text-3xl font-bold leading-relaxed break-keep text-slate-800">{currentQuestion.hint}</p><p className="mt-8 text-lg text-gray-400 font-medium">(ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌïòÎ©¥ Îã´ÌûôÎãàÎã§)</p></div>
                        </div>
                    </div>
                )}
                <div className="relative h-[35%] flex flex-col justify-end p-2 flex-shrink-0 overflow-hidden">
                    <BattleBackground theme={player.theme} />
                    <button onClick={() => { soundService.playClickSound(); setShowHint(p => !p); }} className="absolute top-2 left-2 z-40 bg-yellow-400 hover:bg-yellow-300 text-yellow-900 rounded-full py-2 px-5 shadow-lg border-4 border-white transition-transform active:scale-95 flex items-center gap-2" title="ÌûåÌä∏ Î≥¥Í∏∞"><LightBulbIcon className="w-7 h-7" /><span className="font-extrabold text-xl">ÌûåÌä∏</span></button>
                    {usedItemMessage && <div className="absolute top-32 left-1/2 -translate-x-1/2 z-50 text-3xl font-bold text-yellow-300 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] item-use-msg">{usedItemMessage}</div>}
                    <div className="absolute top-24 left-1/2 -translate-x-1/2 z-50 flex gap-2 pointer-events-auto">{items.map((item) => (<button key={item.id} type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); handleUseItem(item); }} className="bg-white/40 backdrop-blur-md p-3 rounded-full border-2 border-white shadow-xl animate-pulse hover:scale-110 hover:bg-white/60 transition-all active:scale-90 cursor-pointer" title={item.name}>{item.icon}</button>))}</div>
                    <div className="absolute top-2 right-2 sm:right-4 w-[40%] max-w-[150px] z-20"><div className="relative bg-slate-800/80 border border-slate-600 p-1.5 rounded-lg text-right shadow-lg backdrop-blur-sm"><p className="font-bold text-xs sm:text-sm truncate text-red-300 mb-1">{opponent.name}</p><HPBar hp={opponentHP} maxHp={100} isPlayer={false} /></div></div>
                    <div className={`absolute top-[20%] right-[10%] h-[50%] w-[35%] flex justify-center items-center z-10 transition-transform duration-500 ${opponentHit ? 'animate-hit' : ''}`}><div className={`relative w-full h-full flex items-center justify-center ${opponentHit ? 'animate-flash' : ''}`}><img src={opponent.image} alt={opponent.name} className="w-full h-full object-contain drop-shadow-2xl filter contrast-110" />{opponentDamage > 0 && <div className="damage-popup">-{opponentDamage}</div>}</div></div>
                    <div className="absolute bottom-2 left-2 sm:left-4 w-[40%] max-w-[150px] z-20"><div className="relative bg-slate-800/80 border border-slate-600 p-1.5 rounded-lg shadow-lg backdrop-blur-sm"><p className="font-bold text-xs sm:text-sm truncate text-blue-300 mb-1">{player.name}</p><HPBar hp={playerHP} maxHp={100} isPlayer={true} /></div></div>
                    <div className={`absolute bottom-[10%] left-[10%] h-[60%] w-[35%] flex justify-center items-end z-10 transition-transform duration-500 ${playerHit ? 'animate-hit' : ''}`}><div className={`relative w-full h-full flex items-end justify-center ${playerHit ? 'animate-flash' : ''}`}><img src={player.image} alt={player.name} className="w-full h-full object-contain drop-shadow-2xl filter contrast-110" />{playerDamage !== 0 && <div className={`damage-popup ${playerDamage < 0 ? 'heal' : ''}`}>{playerDamage > 0 ? `-${playerDamage}` : `+${Math.abs(playerDamage)}`}</div>}</div></div>
                </div>
                <div className="h-[65%] flex flex-col bg-white/10 backdrop-blur-md rounded-t-3xl overflow-hidden border-t border-white/20 z-10">
                    <header className="px-4 pt-4 pb-2 flex-shrink-0"><div className="flex items-center justify-between text-lg mb-1 text-white drop-shadow-md"><div className="flex items-center gap-2"><TimerIcon className="w-6 h-6" /><span className="font-semibold text-lg">Î¨∏Ï†ú {currentQuestionIndex + 1}/{questions.length}</span></div><span className="font-bold text-lg">{timeLeft}Ï¥à</span></div><div className="w-full bg-gray-700/50 rounded-full h-3 backdrop-blur-sm"><div className={`h-3 rounded-full transition-all duration-300 ${timeLeft <= 5 ? 'bg-red-500' : timeLeft <= 10 ? 'bg-yellow-500' : 'bg-green-500'} shadow-[0_0_10px_rgba(0,0,0,0.3)]`} style={{ width: `${(timeLeft / 15) * 100}%` }}></div></div></header>
                    <main className="flex-grow flex flex-col items-center justify-start bg-slate-100/95 rounded-t-2xl p-4 text-slate-800 shadow-[0_-5px_20px_rgba(0,0,0,0.2)] overflow-y-auto"><h2 className="text-xl md:text-2xl font-bold text-center mb-5 w-full break-keep leading-snug">{currentQuestion.question}</h2><div className="w-full max-w-md grid grid-cols-1 gap-3 pb-4">{currentQuestion.options.map((option, idx) => (<button key={option} onClick={() => handleAnswerSelect(option)} disabled={selectedAnswer !== null} className={`relative w-full py-4 pl-5 pr-12 text-left text-2xl font-bold rounded-xl transition-all duration-200 border-2 shadow-sm flex-shrink-0 active:scale-[0.98] ${getButtonClass(option)}`}><span className="font-extrabold mr-3 opacity-70 text-lg align-middle">{String.fromCharCode(65 + idx)}.</span><span className="align-middle">{option}</span>{selectedAnswer !== null && option === currentQuestion.correctAnswer && <CheckIcon className="absolute right-4 top-1/2 -translate-y-1/2 w-8 h-8 text-green-600" />}{selectedAnswer !== null && selectedAnswer === option && option !== currentQuestion.correctAnswer && <XIcon className="absolute right-4 top-1/2 -translate-y-1/2 w-8 h-8 text-red-600" />}</button>))}</div></main>
                </div>
            </div>
        );
    };

    // --- MAIN APP ---
    const App = () => {
        const [gameState, setGameState] = useState('START');
        const [userAnswers, setUserAnswers] = useState([]);
        const [selectedCharacter, setSelectedCharacter] = useState(null);
        const [opponentMonster, setOpponentMonster] = useState(null);
        const [battleQuestions, setBattleQuestions] = useState([]);
        const [finalPlayerHP, setFinalPlayerHP] = useState(100);
        const [finalOpponentHP, setFinalOpponentHP] = useState(100);
        const [clearedCharacters, setClearedCharacters] = useState([]);

        useEffect(() => {
            if (gameState === 'START' || gameState === 'CHARACTER_SELECTION') soundService.playBGM('menu');
            else if (gameState === 'QUIZ') soundService.playBGM('battle');
            else soundService.stopBGM();
        }, [gameState]);

        const handleStartQuiz = async () => {
            await soundService.resumeContext();
            soundService.playClickSound();
            setGameState('CHARACTER_SELECTION');
        };

        const handleCharacterSelect = (character) => {
            soundService.playClickSound();
            setSelectedCharacter(character);
            setOpponentMonster(monsters[Math.floor(Math.random() * monsters.length)]);
            setBattleQuestions(getQuizQuestions().slice(0, 10));
            setUserAnswers([]);
            setGameState('QUIZ');
        };

        const handleQuizComplete = (answers, playerHP, opponentHP) => {
            setUserAnswers(answers);
            setFinalPlayerHP(playerHP);
            setFinalOpponentHP(opponentHP);
            if (playerHP > opponentHP && selectedCharacter) {
                setClearedCharacters(prev => prev.includes(selectedCharacter.name) ? prev : [...prev, selectedCharacter.name]);
            }
            setGameState('RESULTS');
        };

        const handleRestart = () => {
            soundService.playClickSound();
            setGameState('CHARACTER_SELECTION');
            setUserAnswers([]);
            setSelectedCharacter(null);
            setOpponentMonster(null);
        };

        const getBackgroundClass = () => {
            if (gameState === 'QUIZ') {
                const theme = selectedCharacter?.theme;
                if (theme === 'forest') return 'bg-gradient-to-b from-emerald-500 to-green-800';
                if (theme === 'volcano') return 'bg-gradient-to-b from-orange-600 to-red-900';
                if (theme === 'ocean') return 'bg-gradient-to-b from-cyan-500 to-blue-800';
                if (theme === 'moon') return 'bg-gradient-to-b from-indigo-900 to-purple-900';
                if (theme === 'stage') return 'bg-gradient-to-b from-pink-400 to-purple-700';
                if (theme === 'graveyard') return 'bg-gradient-to-b from-gray-700 to-black';
                if (theme === 'mountain') return 'bg-gradient-to-b from-slate-400 to-slate-700';
                if (theme === 'garden') return 'bg-gradient-to-b from-lime-400 to-green-600';
                return 'bg-gradient-to-b from-sky-400 to-blue-600';
            }
            if (gameState === 'RESULTS') return 'bg-gradient-to-b from-blue-500 to-cyan-600';
            return 'bg-gradient-to-b from-[#4A55A2] to-[#3B437E]';
        };

        return (
            <div className={`w-full max-w-md mx-auto h-full md:max-h-[900px] md:mt-5 md:mb-5 md:rounded-3xl shadow-2xl transition-colors duration-500 overflow-hidden ${getBackgroundClass()}`}>
                <main className="h-full w-full">
                    {gameState === 'START' && <StartScreen onStart={handleStartQuiz} />}
                    {gameState === 'CHARACTER_SELECTION' && <CharacterSelectionScreen onCharacterSelect={handleCharacterSelect} lockedCharacters={clearedCharacters} />}
                    {gameState === 'QUIZ' && selectedCharacter && opponentMonster && <QuizScreen questions={battleQuestions} player={selectedCharacter} opponent={opponentMonster} onComplete={handleQuizComplete} />}
                    {gameState === 'RESULTS' && selectedCharacter && opponentMonster && <ResultsScreen userAnswers={userAnswers} onRestart={handleRestart} player={selectedCharacter} opponent={opponentMonster} playerHP={finalPlayerHP} opponentHP={finalOpponentHP} />}
                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>